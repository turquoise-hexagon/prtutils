#!/usr/bin/env bash

display() {
    declare -n tmp=$1

    for pkg in "${!tmp[@]}"; {
        echo "$pkg : ${tmp[$pkg]}"
    }
}

declare -A n_version y_version

# build a list of packages
for pkg in *; {
    [[ -d $pkg ]] && tmp[i++]=$pkg
}

((
    c = 4,
    i = 0
))

while read -rd \< line; do
    # parse svgs from repology to compare versions
    [[ $line =~ text ]] && ((c++ % 8 == 0)) && {
        var=${line#*>}
        var=${var##*, }
        pkg=${tmp[i++]}

        . "$pkg/Pkgfile" 2> /dev/null || {
            echo "${0##*/} : can't source the Pkgfile for '$pkg'" >&2
        }
        
        case $var in
            -) n_version[$pkg]="$version -> $var";;
            $version) ;; # do nothing
            *) y_version[$pkg]="$version -> $var";;
        esac
    }
done < <(
    curl -s $(
        # build a list of urls
        for pkg in "${tmp[@]}"; {
            [[ -d $pkg ]] && echo "https://repology.org/badge/latest-versions/$pkg.svg"
        }))

display y_version
echo
display n_version
