#!/usr/bin/env bash
#
# check packages for updates

display() {
    declare -n var=$1

    for pkg in "${!var[@]}"; {
        echo "$pkg : ${var[$pkg]}"
    }
}

declare -A a b

for pkg in *; {
    [[ -d $pkg ]] && {
        ((cpt = 0))

        . "$pkg/Pkgfile" 2> /dev/null || {
            echo "${0##*/} : can't source the Pkgfile for '$pkg'" >&2
            exit 1
        }

        while read -r line; do
            [[ $line =~ text ]] && ((++cpt == 5)) && {
                # parse svg
                line=${line#*>}
                line=${line%<*}
                var=${line##*, }

                break
            }
        done < <(curl -s "https://repology.org/badge/latest-versions/$pkg.svg")

        case $var in
            -) b[$pkg]="$version -> $var";;
            $version) ;;
            *) a[$pkg]="$version -> $var";;
        esac
    }
}

display a
echo
display b
