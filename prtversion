#!/usr/bin/env bash
#
# check packages for updates

display() {
    declare -n tmp="$1"

    for msg in "${tmp[@]}"; {
        echo "$msg"
    }
}

# build a list of packages
for dir in */; {
    . "${dir}Pkgfile" 2> /dev/null && {
        tmp_pkg+=("$name")
        tmp_ver+=("$version")
    }
}

while read -r line; do
    # parse svgs
    [[ ${line%</text*} =~ ([^> ]+)$ ]] && var=${BASH_REMATCH[1]}

    pkg=${tmp_pkg[a++]}
    cur=${tmp_ver[b++]}

    case $var in
        -) n_ver+=("$pkg : $cur -> $var");;
        $cur) ;; # do nothing
        *) y_ver+=("$pkg : $cur -> $var")
    esac
done < <(
    curl -w '\n' -s $(
        # build a list of urls
        printf 'https://repology.org/badge/latest-versions/%s.svg ' "${tmp_pkg[@]}"
    ))

display y_ver
display n_ver
